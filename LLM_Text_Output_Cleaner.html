<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Text Normaliser ‚Äî ASCII Converter with #Flagging</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#f7f9fc;
    --panel:#ffffff;
    --ink:#0b1526;
    --ink-2:#55637a;
    --accent:#1c6ef2;
    --ok:#059669;
    --warn:#b45309;
    --muted:#e5e7eb;
    --chip:#eef2ff;
    --mark:#fff4cc;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  *{box-sizing:border-box}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  .h1{font-size:20px;font-weight:700;margin:0 0 12px}
  .sub{color:var(--ink-2);margin:2px 0 16px}
  .grid{display:grid;grid-template-columns:1.1fr 0.9fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--muted);border-radius:10px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  textarea{width:100%;min-height:260px;resize:vertical;border:1px solid var(--muted);border-radius:8px;padding:10px 12px;font:13px/1.45 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .mono{font:12px ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .btn{appearance:none;border:1px solid var(--accent);background:#fff;color:var(--accent);padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .btn.solid{background:var(--accent);color:#fff}
  .btn.warn{border-color:var(--warn);color:var(--warn)}
  .btn.green{border-color:var(--ok);color:var(--ok)}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip);color:#1e3a8a;font-weight:600}
  label.chk{display:flex;align-items:center;gap:8px;margin:4px 8px 4px 0;font-size:13px}
  .cols{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .tbl{width:100%;border-collapse:separate;border-spacing:0 6px}
  .tbl th{font-weight:700;text-align:left;color:var(--ink-2);font-size:12px}
  .tbl td{background:#fff;border:1px solid var(--muted);border-left:4px solid #e9eefc;padding:6px 8px;border-radius:6px}
  .tbl td:first-child{width:50%}
  .stat{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .kpi{background:#fff;border:1px solid var(--muted);border-radius:10px;padding:10px 12px;text-align:center}
  .kpi b{display:block;font-size:16px}
  .small{font-size:12px;color:var(--ink-2)}
  .legend{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  mark{background:var(--mark);padding:0 2px;border-radius:3px}
  .note{color:var(--ink-2);font-size:12px;margin-top:6px}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .preview{border:1px dashed var(--muted);border-radius:8px;padding:10px 12px;background:#fff;min-height:100px;white-space:pre-wrap;font:13px/1.45 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .opts{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin:8px 0}
  .section-title{font-weight:700;margin:6px 0 4px}
  .file{display:inline-block}
  .analysis-window{border:1px solid var(--muted);border-radius:8px;padding:10px 12px;background:#fff;min-height:120px;white-space:pre-wrap;font:13px/1.45 ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;margin-top:8px}
  .disallowed-char{background-color:#8B0000;color:#fff;padding:1px 2px;border-radius:2px;font-weight:bold}
  .empty-char{background-color:#DC143C;color:#fff;padding:1px 2px;border-radius:2px;font-weight:bold}
  .unicode-range-input{width:100%;padding:6px 8px;border:1px solid var(--muted);border-radius:6px;font:12px ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;margin:4px 0}
  .range-controls{display:flex;gap:8px;align-items:center;margin:8px 0}
  .range-list{max-height:100px;overflow-y:auto;border:1px solid var(--muted);border-radius:6px;padding:8px;background:#f9f9f9;font:11px ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Text Normaliser ‚Äî Standard ASCII Conversion with #Flagging</div>
  <div class="sub">Converts typographic punctuation and non-standard spacing into standard ASCII (hyphen, straight quotes, single spaces, normal slashes). Any remaining disallowed characters are wrapped as <span class="chip">#X#</span> so they are easy to find.</div>

  <div class="grid">
    <div class="panel">
      <div class="section-title">Input</div>
      <div class="row">
        <button class="btn" id="pasteBtn" title="Paste from clipboard">Paste</button>
        <label class="file">
          <input type="file" id="fileIn" accept=".txt,.md,.csv,.tsv,.json,.log,.html,.xml,.yml,.yaml,.ini" style="display:none">
          <span class="btn">Open .txt</span>
        </label>
        <button class="btn warn" id="clearBtn">Clear</button>
        <span class="small">Sample: <button class="btn" id="sampleBtn">Insert demo</button></span>
      </div>
      <textarea id="in" placeholder="Paste or type text here‚Ä¶"></textarea>

      <div class="section-title">Character Analysis</div>
      <div id="analysisWindow" class="analysis-window" aria-live="polite">Analysis will appear here...</div>

      <div class="section-title">Permissible Character Ranges</div>
      <div class="range-controls">
        <input type="text" id="unicodeRangeInput" class="unicode-range-input" placeholder="Enter Unicode range (e.g., U+0020-U+007E)" />
        <button class="btn" id="addRangeBtn">Add Range</button>
        <button class="btn warn" id="toggleSetsBtn">Switch to Extended Set</button>
      </div>
      <div id="rangeList" class="range-list">Loading default ranges...</div>

      <div class="section-title">Conversion rules</div>
      <div class="opts">
        <label class="chk"><input type="checkbox" id="rDashes" checked> Dashes ‚Üí hyphen ‚Äú‚Äî ‚Äì ‚Äí ‚àí ‚Äï‚Äù ‚Üí ‚Äú-‚Äù</label>
        <label class="chk"><input type="checkbox" id="rQuotes" checked> Typographic quotes ‚Üí straight ‚Äú ‚Äù ‚Äò ‚Äô ¬´ ¬ª ‚Äπ ‚Ä∫ ‚Üí " ' </label>
        <label class="chk"><input type="checkbox" id="rApos" checked> Apostrophe ‚Äô ‚Üí '</label>
        <label class="chk"><input type="checkbox" id="rEllip" checked> Ellipsis ‚Ä¶ ‚Üí ...</label>
        <label class="chk"><input type="checkbox" id="rBullets" checked> Bullets/¬∑ ‚Üí -</label>
        <label class="chk"><input type="checkbox" id="rSpaces" checked> Non-standard spaces ‚Üí normal space</label>
        <label class="chk"><input type="checkbox" id="rCollapse"> Collapse multiple spaces to one</label>
        <label class="chk"><input type="checkbox" id="rZwj" checked> Remove zero-width & soft hyphen</label>
        <label class="chk"><input type="checkbox" id="rFullwidth" checked> Fullwidth ASCII ‚Üí normal ASCII</label>
        <label class="chk"><input type="checkbox" id="rSlashes" checked> Unicode slashes ‚àï ‚ÅÑ ‚Üí /</label>
        <label class="chk"><input type="checkbox" id="rLineSep" checked> Unicode line/para separators ‚Üí newline</label>
        <label class="chk"><input type="checkbox" id="rTrimLines"> Trim line ends</label>
        <label class="chk"><input type="checkbox" id="rCompat"> Unicode NFKC compatibility fold</label>
        <label class="chk"><input type="checkbox" id="rStripDia"> Strip combining diacritics</label>
      </div>

      <div class="row">
        <label class="chk"><input type="checkbox" id="flagAsciiOnly" checked> Flag any character outside ASCII printable + tab/newline/CR</label>
        <label class="chk"><input type="checkbox" id="allowVietnamese" checked> Allow Vietnamese characters</label>
        <label class="chk"><input type="checkbox" id="showPreview" checked> Highlight flagged in preview</label>
      </div>

      <div class="foot">
        <div class="legend small">
          <span>Allowed set: <code class="mono">[TAB, LF, CR, 0x20‚Äì0x7E]</code></span>
        </div>
        <button class="btn solid" id="convertBtn">Convert</button>
      </div>
    </div>

    <div class="panel">
      <div class="section-title">Output</div>
      <div class="row">
        <button class="btn green" id="copyOutBtn">Copy output</button>
        <button class="btn" id="downloadBtn">Download .txt</button>
        <span id="status" class="small"></span>
      </div>
      <textarea id="out" placeholder="Converted text appears here‚Ä¶" readonly></textarea>

      <div class="section-title">Flagged-character preview</div>
      <div id="preview" class="preview" aria-live="polite"></div>

      <div class="stat">
        <div class="kpi"><b id="kIn">0</b><span class="small">Input chars</span></div>
        <div class="kpi"><b id="kOut">0</b><span class="small">Output chars</span></div>
        <div class="kpi"><b id="kRepl">0</b><span class="small">Replacements</span></div>
        <div class="kpi"><b id="kFlag">0</b><span class="small">Flagged chars</span></div>
        <div class="kpi"><b id="kDisallowed">0</b><span class="small">Disallowed chars</span></div>
        <div class="kpi"><b id="kEmpty">0</b><span class="small">Empty chars</span></div>
      </div>

      <div class="section-title">Replacement summary</div>
      <table class="tbl" id="replTbl">
        <thead><tr><th>Rule</th><th class="mono">Count</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="section-title">Flagged characters</div>
      <table class="tbl" id="flagTbl">
        <thead><tr><th>Character ‚Ä¢ Code point ‚Ä¢ Hint</th><th class="mono">Count</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="note">Each flagged character appears in output wrapped as <code class="mono">#X#</code>. Counts are computed before wrapping. The preview highlights the wrapped segments for quick visual scanning.</div>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  // Elements
  const elIn = document.getElementById('in');
  const elOut = document.getElementById('out');
  const preview = document.getElementById('preview');
  const analysisWindow = document.getElementById('analysisWindow');
  const kIn = document.getElementById('kIn');
  const kOut = document.getElementById('kOut');
  const kRepl = document.getElementById('kRepl');
  const kFlag = document.getElementById('kFlag');
  const kDisallowed = document.getElementById('kDisallowed');
  const kEmpty = document.getElementById('kEmpty');
  const replTbl = document.querySelector('#replTbl tbody');
  const flagTbl = document.querySelector('#flagTbl tbody');
  const status = document.getElementById('status');
  const unicodeRangeInput = document.getElementById('unicodeRangeInput');
  const addRangeBtn = document.getElementById('addRangeBtn');
  const toggleSetsBtn = document.getElementById('toggleSetsBtn');
  const rangeList = document.getElementById('rangeList');

  // Controls
  const rDashes = document.getElementById('rDashes');
  const rQuotes = document.getElementById('rQuotes');
  const rApos = document.getElementById('rApos');
  const rEllip = document.getElementById('rEllip');
  const rBullets = document.getElementById('rBullets');
  const rSpaces = document.getElementById('rSpaces');
  const rCollapse = document.getElementById('rCollapse');
  const rZwj = document.getElementById('rZwj');
  const rFullwidth = document.getElementById('rFullwidth');
  const rSlashes = document.getElementById('rSlashes');
  const rLineSep = document.getElementById('rLineSep');
  const rTrimLines = document.getElementById('rTrimLines');
  const rCompat = document.getElementById('rCompat');
  const rStripDia = document.getElementById('rStripDia');
  const flagAsciiOnly = document.getElementById('flagAsciiOnly');
  const allowVietnamese = document.getElementById('allowVietnamese');
  const showPreview = document.getElementById('showPreview');

  const convertBtn = document.getElementById('convertBtn');
  const copyOutBtn = document.getElementById('copyOutBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const pasteBtn = document.getElementById('pasteBtn');
  const clearBtn = document.getElementById('clearBtn');
  const sampleBtn = document.getElementById('sampleBtn');
  const fileIn = document.getElementById('fileIn');

  // --------------------CONSTANTS & CONFIGURATIONS
  // Character set definitions
  const MINIMUM_SET = [
    { start: 0x0009, end: 0x0009, name: 'TAB' },
    { start: 0x000A, end: 0x000A, name: 'LF' },
    { start: 0x000D, end: 0x000D, name: 'CR' },
    { start: 0x0020, end: 0x007E, name: 'Printable ASCII' }
  ];

  const VIETNAMESE_RANGES = [
    { start: 0x00C0, end: 0x00FF, name: 'Latin-1 Supplement (Vietnamese)' },
    { start: 0x0100, end: 0x017F, name: 'Latin Extended-A (Vietnamese)' },
    { start: 0x0180, end: 0x024F, name: 'Latin Extended-B (Vietnamese: ∆∞, ∆°, etc.)' },
    { start: 0x1E00, end: 0x1EFF, name: 'Latin Extended Additional (Vietnamese)' }
  ];

  const EXTENDED_SET = [
    { start: 0x0009, end: 0x0009, name: 'TAB' },
    { start: 0x000A, end: 0x000A, name: 'LF' },
    { start: 0x000D, end: 0x000D, name: 'CR' },
    { start: 0x0020, end: 0x007E, name: 'Printable ASCII' },
    { start: 0x00A0, end: 0x00A0, name: 'Non-breaking space' },
    { start: 0x0180, end: 0x024F, name: 'Latin Extended-B' },
    { start: 0x2000, end: 0x206F, name: 'General Punctuation' },
    { start: 0x2070, end: 0x209F, name: 'Superscripts and Subscripts' },
    { start: 0x20A0, end: 0x20CF, name: 'Currency Symbols' },
    { start: 0x2100, end: 0x214F, name: 'Letterlike Symbols' },
    { start: 0x2150, end: 0x218F, name: 'Number Forms' },
    { start: 0x2190, end: 0x21FF, name: 'Arrows' },
    { start: 0x2200, end: 0x22FF, name: 'Mathematical Operators' },
    { start: 0x2300, end: 0x23FF, name: 'Miscellaneous Technical' },
    { start: 0x2400, end: 0x243F, name: 'Control Pictures' },
    { start: 0x2460, end: 0x24FF, name: 'Enclosed Alphanumerics' },
    { start: 0x2500, end: 0x257F, name: 'Box Drawing' },
    { start: 0x2580, end: 0x259F, name: 'Block Elements' },
    { start: 0x25A0, end: 0x25FF, name: 'Geometric Shapes' },
    { start: 0x2600, end: 0x26FF, name: 'Miscellaneous Symbols' },
    { start: 0x2700, end: 0x27BF, name: 'Dingbats' },
    { start: 0x27C0, end: 0x27EF, name: 'Miscellaneous Mathematical Symbols-A' },
    { start: 0x27F0, end: 0x27FF, name: 'Supplemental Arrows-A' },
    { start: 0x2800, end: 0x28FF, name: 'Braille Patterns' },
    { start: 0x2900, end: 0x297F, name: 'Supplemental Arrows-B' },
    { start: 0x2980, end: 0x29FF, name: 'Miscellaneous Mathematical Symbols-B' },
    { start: 0x2A00, end: 0x2AFF, name: 'Supplemental Mathematical Operators' },
    { start: 0x2B00, end: 0x2BFF, name: 'Miscellaneous Symbols and Arrows' },
    { start: 0x2C00, end: 0x2C5F, name: 'Glagolitic' },
    { start: 0x2C60, end: 0x2C7F, name: 'Latin Extended-C' },
    { start: 0x2C80, end: 0x2CFF, name: 'Coptic' },
    { start: 0x2D00, end: 0x2D2F, name: 'Georgian Supplement' },
    { start: 0x2D30, end: 0x2D7F, name: 'Tifinagh' },
    { start: 0x2D80, end: 0x2DDF, name: 'Ethiopic Extended' },
    { start: 0x2DE0, end: 0x2DFF, name: 'Cyrillic Extended-A' },
    { start: 0x2E00, end: 0x2E7F, name: 'Supplemental Punctuation' },
    { start: 0x2E80, end: 0x2EFF, name: 'CJK Radicals Supplement' },
    { start: 0x2F00, end: 0x2FDF, name: 'Kangxi Radicals' },
    { start: 0x2FF0, end: 0x2FFF, name: 'Ideographic Description Characters' },
    { start: 0x3000, end: 0x303F, name: 'CJK Symbols and Punctuation' },
    { start: 0x3040, end: 0x309F, name: 'Hiragana' },
    { start: 0x30A0, end: 0x30FF, name: 'Katakana' },
    { start: 0x3100, end: 0x312F, name: 'Bopomofo' },
    { start: 0x3130, end: 0x318F, name: 'Hangul Compatibility Jamo' },
    { start: 0x3190, end: 0x319F, name: 'Kanbun' },
    { start: 0x31A0, end: 0x31BF, name: 'Bopomofo Extended' },
    { start: 0x31C0, end: 0x31EF, name: 'CJK Strokes' },
    { start: 0x31F0, end: 0x31FF, name: 'Katakana Phonetic Extensions' },
    { start: 0x3200, end: 0x32FF, name: 'Enclosed CJK Letters and Months' },
    { start: 0x3300, end: 0x33FF, name: 'CJK Compatibility' },
    { start: 0x3400, end: 0x4DBF, name: 'CJK Unified Ideographs Extension A' },
    { start: 0x4DC0, end: 0x4DFF, name: 'Yijing Hexagram Symbols' },
    { start: 0x4E00, end: 0x9FFF, name: 'CJK Unified Ideographs' },
    { start: 0xA000, end: 0xA48F, name: 'Yi Syllables' },
    { start: 0xA490, end: 0xA4CF, name: 'Yi Radicals' },
    { start: 0xA4D0, end: 0xA4FF, name: 'Lisu' },
    { start: 0xA500, end: 0xA63F, name: 'Vai' },
    { start: 0xA640, end: 0xA69F, name: 'Cyrillic Extended-B' },
    { start: 0xA6A0, end: 0xA6FF, name: 'Bamum' },
    { start: 0xA700, end: 0xA71F, name: 'Modifier Tone Letters' },
    { start: 0xA720, end: 0xA7FF, name: 'Latin Extended-D' },
    { start: 0xA800, end: 0xA82F, name: 'Syloti Nagri' },
    { start: 0xA830, end: 0xA83F, name: 'Common Indic Number Forms' },
    { start: 0xA840, end: 0xA87F, name: 'Phags-pa' },
    { start: 0xA880, end: 0xA8DF, name: 'Saurashtra' },
    { start: 0xA8E0, end: 0xA8FF, name: 'Devanagari Extended' },
    { start: 0xA900, end: 0xA92F, name: 'Kayah Li' },
    { start: 0xA930, end: 0xA95F, name: 'Rejang' },
    { start: 0xA960, end: 0xA97F, name: 'Hangul Jamo Extended-A' },
    { start: 0xA980, end: 0xA9DF, name: 'Javanese' },
    { start: 0xA9E0, end: 0xA9FF, name: 'Myanmar Extended-B' },
    { start: 0xAA00, end: 0xAA5F, name: 'Cham' },
    { start: 0xAA60, end: 0xAA7F, name: 'Myanmar Extended-A' },
    { start: 0xAA80, end: 0xAADF, name: 'Tai Viet' },
    { start: 0xAAE0, end: 0xAAFF, name: 'Meetei Mayek Extensions' },
    { start: 0xAB00, end: 0xAB2F, name: 'Ethiopic Extended-A' },
    { start: 0xAB30, end: 0xAB6F, name: 'Latin Extended-E' },
    { start: 0xAB70, end: 0xABBF, name: 'Cherokee Supplement' },
    { start: 0xABC0, end: 0xABFF, name: 'Meetei Mayek' },
    { start: 0xAC00, end: 0xD7AF, name: 'Hangul Syllables' },
    { start: 0xD7B0, end: 0xD7FF, name: 'Hangul Jamo Extended-B' },
    { start: 0xD800, end: 0xDB7F, name: 'High Surrogates' },
    { start: 0xDB80, end: 0xDBFF, name: 'High Private Use Surrogates' },
    { start: 0xDC00, end: 0xDFFF, name: 'Low Surrogates' },
    { start: 0xE000, end: 0xF8FF, name: 'Private Use Area' },
    { start: 0xF900, end: 0xFAFF, name: 'CJK Compatibility Ideographs' },
    { start: 0xFB00, end: 0xFB4F, name: 'Alphabetic Presentation Forms' },
    { start: 0xFB50, end: 0xFDFF, name: 'Arabic Presentation Forms-A' },
    { start: 0xFE00, end: 0xFE0F, name: 'Variation Selectors' },
    { start: 0xFE10, end: 0xFE1F, name: 'Vertical Forms' },
    { start: 0xFE20, end: 0xFE2F, name: 'Combining Half Marks' },
    { start: 0xFE30, end: 0xFE4F, name: 'CJK Compatibility Forms' },
    { start: 0xFE50, end: 0xFE6F, name: 'Small Form Variants' },
    { start: 0xFE70, end: 0xFEFF, name: 'Arabic Presentation Forms-B' },
    { start: 0xFF00, end: 0xFFEF, name: 'Halfwidth and Fullwidth Forms' },
    { start: 0xFFF0, end: 0xFFFF, name: 'Specials' }
  ];

  // Current character set state
  let currentSet = 'minimum';
  let permissibleRanges = [...MINIMUM_SET];

  // --------------------GUI COMPONENTS
  // Helpers
  const isCharInRange = (codePoint, ranges) => {
    return ranges.some(range => codePoint >= range.start && codePoint <= range.end);
  };

  const allowedChar = (ch) => {
    if (!flagAsciiOnly.checked) return true;
    const code = ch.codePointAt(0);
    // Check base permissible ranges
    if (isCharInRange(code, permissibleRanges)) return true;
    // Check Vietnamese ranges if enabled
    if (allowVietnamese.checked && isCharInRange(code, VIETNAMESE_RANGES)) return true;
    return false;
  };

  const isCharEmpty = (ch) => {
    // Check for characters that have no visual representation
    const code = ch.codePointAt(0);
    return code === 0x200B || // Zero Width Space
           code === 0x200C || // Zero Width Non-Joiner
           code === 0x200D || // Zero Width Joiner
           code === 0x2060 || // Word Joiner
           code === 0xFEFF || // Zero Width No-Break Space
           code === 0x00AD || // Soft Hyphen
           code === 0x180E;   // Mongolian Vowel Separator
  };
  const escHtml = (s) => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const pad2 = (n)=> (n<10?'0':'')+n;

  // Unicode range management functions
  const updateRangeList = () => {
    let rangesToShow = [...permissibleRanges];
    // Add Vietnamese ranges if enabled
    if (allowVietnamese.checked) {
      rangesToShow = [...rangesToShow, ...VIETNAMESE_RANGES];
      rangesToShow.sort((a, b) => a.start - b.start);
    }
    rangeList.innerHTML = rangesToShow.map(range => 
      `<div>U+${range.start.toString(16).toUpperCase().padStart(4,'0')}-U+${range.end.toString(16).toUpperCase().padStart(4,'0')} (${range.name})</div>`
    ).join('');
  };

  const parseUnicodeRange = (input) => {
    const clean = input.trim().toUpperCase();
    const match = clean.match(/U\+([0-9A-F]{1,6})-U\+([0-9A-F]{1,6})/);
    if (match) {
      const start = parseInt(match[1], 16);
      const end = parseInt(match[2], 16);
      if (start <= end && start >= 0 && end <= 0x10FFFF) {
        return { start, end, name: `Custom Range U+${match[1]}-U+${match[2]}` };
      }
    }
    return null;
  };

  const addUnicodeRange = (range) => {
    if (range && !permissibleRanges.some(r => r.start === range.start && r.end === range.end)) {
      permissibleRanges.push(range);
      permissibleRanges.sort((a, b) => a.start - b.start);
      updateRangeList();
      update();
    }
  };

  const toggleCharacterSet = () => {
    if (currentSet === 'minimum') {
      currentSet = 'extended';
      permissibleRanges = [...EXTENDED_SET];
      toggleSetsBtn.textContent = 'Switch to Minimum Set';
      toggleSetsBtn.className = 'btn green';
    } else {
      currentSet = 'minimum';
      permissibleRanges = [...MINIMUM_SET];
      toggleSetsBtn.textContent = 'Switch to Extended Set';
      toggleSetsBtn.className = 'btn warn';
    }
    updateRangeList();
    update();
  };

  // Character analysis function
  const analyzeCharacters = (text) => {
    const chars = [...text];
    let analysisHtml = '';
    let disallowedCount = 0;
    let emptyCount = 0;

    for (let i = 0; i < chars.length; i++) {
      const ch = chars[i];
      const code = ch.codePointAt(0);
      
      if (isCharEmpty(ch)) {
        analysisHtml += `<span class="empty-char" title="Empty character: U+${code.toString(16).toUpperCase()}">‚ñ°</span>`;
        emptyCount++;
        disallowedCount++; // Empty characters are also counted as disallowed
      } else if (!allowedChar(ch)) {
        analysisHtml += `<span class="disallowed-char" title="Disallowed character: U+${code.toString(16).toUpperCase()}">${escHtml(ch)}</span>`;
        disallowedCount++;
      } else {
        analysisHtml += escHtml(ch);
      }
    }

    return {
      html: analysisHtml,
      disallowedCount,
      emptyCount,
      totalChars: chars.length
    };
  };

  // Known names for reporting (not exhaustive)
  const NAME_HINT = new Map([
    [0x00A0, 'NO-BREAK SPACE'],
    [0x2000, 'EN QUAD'],[0x2001,'EM QUAD'],
    [0x2002,'EN SPACE'],[0x2003,'EM SPACE'],
    [0x2004,'THREE-PER-EM SPACE'],[0x2005,'FOUR-PER-EM SPACE'],
    [0x2006,'SIX-PER-EM SPACE'],[0x2007,'FIGURE SPACE'],
    [0x2008,'PUNCTUATION SPACE'],[0x2009,'THIN SPACE'],
    [0x200A,'HAIR SPACE'],[0x202F,'NARROW NO-BREAK SPACE'],
    [0x205F,'MEDIUM MATHEMATICAL SPACE'],[0x3000,'IDEOGRAPHIC SPACE'],
    [0x200B,'ZERO WIDTH SPACE'],[0x200C,'ZERO WIDTH NON-JOINER'],[0x200D,'ZERO WIDTH JOINER'],
    [0x2060,'WORD JOINER'],[0xFEFF,'ZERO WIDTH NO-BREAK SPACE'],
    [0x00AD,'SOFT HYPHEN'],
    [0x2013,'EN DASH'],[0x2014,'EM DASH'],[0x2015,'HORIZONTAL BAR'],
    [0x2012,'FIGURE DASH'],[0x2212,'MINUS SIGN'],
    [0x2018,'LEFT SINGLE QUOTATION MARK'],[0x2019,'RIGHT SINGLE QUOTATION MARK'],
    [0x201A,'SINGLE LOW-9 QUOTATION MARK'],[0x201B,'SINGLE HIGH-REVERSED-9 QUOTATION MARK'],
    [0x201C,'LEFT DOUBLE QUOTATION MARK'],[0x201D,'RIGHT DOUBLE QUOTATION MARK'],
    [0x201E,'DOUBLE LOW-9 QUOTATION MARK'],[0x201F,'DOUBLE HIGH-REVERSED-9 QUOTATION MARK'],
    [0x00AB,'LEFT-POINTING DOUBLE ANGLE QUOTATION MARK'],[0x00BB,'RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK'],
    [0x2039,'SINGLE LEFT-POINTING ANGLE QUOTATION MARK'],[0x203A,'SINGLE RIGHT-POINTING ANGLE QUOTATION MARK'],
    [0x2026,'HORIZONTAL ELLIPSIS'],
    [0x2215,'DIVISION SLASH'],[0x2044,'FRACTION SLASH'],
    [0x00B7,'MIDDLE DOT'],[0x2022,'BULLET'],
    [0x2028,'LINE SEPARATOR'],[0x2029,'PARAGRAPH SEPARATOR']
  ]);

  // Replacement engine with counting
  function replaceCount(s, regex, replacement, label, stats){
    const matches = s.match(regex);
    const count = matches ? matches.length : 0;
    if (count > 0) {
      s = s.replace(regex, replacement);
      stats.replCounts.set(label, (stats.replCounts.get(label) || 0) + count);
      stats.totalRepl += count;
    }
    return s;
  }

  // Fullwidth ASCII conversion (FF01‚ÄìFF5E ‚Üí 21‚Äì7E)
  function mapFullwidthToAscii(s, stats){
    let count = 0;
    s = s.replace(/[\uFF01-\uFF5E]/g, ch=>{
      count++;
      return String.fromCharCode(ch.charCodeAt(0)-0xFEE0);
    });
    if (count) { stats.replCounts.set('Fullwidth ASCII ‚Üí ASCII', (stats.replCounts.get('Fullwidth ASCII ‚Üí ASCII')||0)+count); stats.totalRepl += count; }
    // Fullwidth space is 3000, handled in space rule
    return s;
  }

  // Combining diacritics (explicit ranges for portability)
  const COMBINING = /[\u0300-\u036F\u1AB0-\u1AFF\u1DC0-\u1DFF\u20D0-\u20FF\uFE20-\uFE2F]/g;

  function normalise(input){
    const stats = { totalRepl:0, replCounts:new Map(), flagged:new Map(), flaggedTotal:0 };
    let s = input;

    // Unify line endings first
    s = s.replace(/\r\n?/g, '\n');

    if (rCompat.checked && s.normalize) {
      const before = s;
      s = s.normalize('NFKC');
      if (s !== before) {
        // Estimate count by diffing code points quickly
        const diff = Math.max(0, [...before].length - [...s].length) || 1;
        stats.replCounts.set('Unicode NFKC fold', (stats.replCounts.get('Unicode NFKC fold')||0)+diff);
        stats.totalRepl += diff;
      }
    }

    if (rZwj.checked) {
      s = replaceCount(s, /[\u200B\u200C\u200D\u2060\uFEFF\u180E]/g, '', 'Remove zero-width', stats);
      s = replaceCount(s, /\u00AD/g, '', 'Remove soft hyphen', stats);
    }

    if (rLineSep.checked) {
      s = replaceCount(s, /\u2028/g, '\n', 'Line separator ‚Üí \\n', stats);
      s = replaceCount(s, /\u2029/g, '\n\n', 'Paragraph separator ‚Üí \\n\\n', stats);
    }

    if (rSpaces.checked) {
      s = replaceCount(s, /[\u00A0\u2000-\u200A\u202F\u205F\u3000]/g, ' ', 'Non-standard spaces ‚Üí space', stats);
    }

    if (rCollapse.checked) {
      // Collapse runs of spaces (but not newlines)
      s = replaceCount(s, /[ ]{2,}/g, ' ', 'Collapse spaces', stats);
      // Optionally collapse tabs around spaces to single space
      s = replaceCount(s, /(?:[ \t]*\t[ \t]*)+/g, '\t', 'Normalise tabs', stats);
    }

    if (rDashes.checked) {
      s = replaceCount(s, /[\u2012\u2013\u2014\u2015\u2212]/g, '-', 'Dashes/Minus ‚Üí -', stats);
    }

    if (rQuotes.checked) {
      s = replaceCount(s, /[\u201C\u201D\u201E\u201F\u00AB\u00BB]/g, '"', 'Double quotes ‚Üí "', stats);
      s = replaceCount(s, /[\u2018\u2019\u201A\u201B\u2039\u203A]/g, "'", 'Single quotes ‚Üí \'', stats);
    }

    if (rApos.checked) {
      s = replaceCount(s, /\u2019/g, "'", 'Apostrophe ‚Üí \'', stats); // already in above; kept for clarity
    }

    if (rEllip.checked) {
      s = replaceCount(s, /\u2026/g, '...', 'Ellipsis ‚Üí ...', stats);
    }

    if (rBullets.checked) {
      s = replaceCount(s, /[\u2022\u00B7]/g, '-', 'Bullets/Middle dot ‚Üí -', stats);
    }

    if (rSlashes.checked) {
      s = replaceCount(s, /[\u2044\u2215]/g, '/', 'Unicode slashes ‚Üí /', stats);
    }

    if (rFullwidth.checked) {
      s = mapFullwidthToAscii(s, stats);
    }

    if (rTrimLines.checked) {
      // Trim trailing spaces/tabs on each line
      const before = s;
      s = s.replace(/[ \t]+$/gm, '');
      if (s !== before) {
        const cnt = (before.match(/[ \t]+$/gm) || []).length;
        if (cnt) { stats.replCounts.set('Trim line ends', (stats.replCounts.get('Trim line ends')||0)+cnt); stats.totalRepl += cnt; }
      }
    }

    if (rStripDia.checked) {
      const before = s;
      // Prefer NFD to separate base letters then strip combining marks
      s = s.normalize ? s.normalize('NFD').replace(COMBINING, '') : s.replace(COMBINING, '');
      if (s !== before) {
        const cnt = (before.match(COMBINING) || []).length;
        if (cnt) { stats.replCounts.set('Strip diacritics', (stats.replCounts.get('Strip diacritics')||0)+cnt); stats.totalRepl += cnt; }
      }
    }

    // Final pass: flag any remaining disallowed characters with #X#
    // Do not double-wrap if the char is '#'
    // Also avoid wrapping if the char is already in a #X# triplet produced by this tool
    let flaggedTotal = 0;
    let out = '';
    const chars = [...s];
    for (let i=0; i<chars.length; i++){
      const ch = chars[i];
      const code = ch.codePointAt(0);

      // Detect pre-existing #X# triplets produced earlier in this run
      if (ch === '#' && i+2 < chars.length && chars[i+2] === '#') {
        // leave as-is; skip ahead only if this is our own pattern (#?#)
        out += ch;
        continue;
      }

      if (!allowedChar(ch) && ch !== '#') {
        out += '#' + ch + '#';
        flaggedTotal++;
        const key = code;
        stats.flagged.set(key, (stats.flagged.get(key)||0)+1);
      } else {
        out += ch;
      }
    }
    stats.flaggedTotal = flaggedTotal;

    return { out, stats };
  }

  function update(){
    const src = elIn.value || '';
    const { out, stats } = normalise(src);
    elOut.value = out;

    // Character analysis
    const analysis = analyzeCharacters(src);
    analysisWindow.innerHTML = analysis.html;

    // KPIs
    kIn.textContent = [...src].length.toString();
    kOut.textContent = [...out].length.toString();
    kRepl.textContent = stats.totalRepl.toString();
    kFlag.textContent = stats.flaggedTotal.toString();
    kDisallowed.textContent = analysis.disallowedCount.toString();
    kEmpty.textContent = analysis.emptyCount.toString();

    // Replacement table
    replTbl.innerHTML = '';
    const entries = [...stats.replCounts.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    for (const [label,count] of entries){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${escHtml(label)}</td><td class="mono">${count}</td>`;
      replTbl.appendChild(tr);
    }
    if (!entries.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="small">No replacements applied</td><td class="mono">0</td>`;
      replTbl.appendChild(tr);
    }

    // Flag table
    flagTbl.innerHTML = '';
    if (stats.flagged.size){
      const flags = [...stats.flagged.entries()].sort((a,b)=>a[0]-b[0]);
      for (const [cp,count] of flags){
        const ch = String.fromCodePoint(cp);
        const hex = cp.toString(16).toUpperCase().padStart(4,'0');
        const dec = cp.toString(10);
        const hint = NAME_HINT.get(cp) || 'Unknown character';
        const safe = escHtml(ch);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td><span class="mono">‚Äò${safe}‚Äô</span> ‚Ä¢ U+${hex} (${dec}) ‚Ä¢ ${escHtml(hint)}</td><td class="mono">${count}</td>`;
        flagTbl.appendChild(tr);
      }
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="small">No characters required flagging</td><td class="mono">0</td>`;
      flagTbl.appendChild(tr);
    }

    // Preview with highlighted #X# segments for visibility
    if (showPreview.checked){
      const safe = escHtml(elOut.value);
      // Highlight any #X# pattern; using reluctant match to mark small spans
      const highlighted = safe.replace(/#(.{1}?)#/g, '<mark>#$1#</mark>');
      preview.innerHTML = highlighted;
    } else {
      preview.textContent = elOut.value;
    }
  }

  // Wire events
  for (const id of [
    'rDashes','rQuotes','rApos','rEllip','rBullets','rSpaces','rCollapse',
    'rZwj','rFullwidth','rSlashes','rLineSep','rTrimLines','rCompat','rStripDia',
    'flagAsciiOnly','allowVietnamese','showPreview'
  ]){
    document.getElementById(id).addEventListener('change', () => {
      updateRangeList();
      update();
    });
  }
  elIn.addEventListener('input', update);
  document.getElementById('convertBtn').addEventListener('click', update);

  // Unicode range management events
  addRangeBtn.addEventListener('click', () => {
    const range = parseUnicodeRange(unicodeRangeInput.value);
    if (range) {
      addUnicodeRange(range);
      unicodeRangeInput.value = '';
      status.textContent = 'Range added';
      setTimeout(() => status.textContent = '', 1500);
    } else {
      status.textContent = 'Invalid range format';
      setTimeout(() => status.textContent = '', 1500);
    }
  });

  toggleSetsBtn.addEventListener('click', () => {
    toggleCharacterSet();
    status.textContent = `Switched to ${currentSet} set`;
    setTimeout(() => status.textContent = '', 1500);
  });

  unicodeRangeInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      addRangeBtn.click();
    }
  });

  copyOutBtn.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(elOut.value);
      status.textContent = 'Copied';
      setTimeout(()=>status.textContent='', 1200);
    }catch(e){
      status.textContent = 'Copy failed';
      setTimeout(()=>status.textContent='', 1500);
    }
  });

  downloadBtn.addEventListener('click', ()=>{
    const now = new Date();
    const fname = `converted-${now.getFullYear()}${pad2(now.getMonth()+1)}${pad2(now.getDate())}-${pad2(now.getHours())}${pad2(now.getMinutes())}${pad2(now.getSeconds())}.txt`;
    const blob = new Blob([elOut.value], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  });

  pasteBtn.addEventListener('click', async ()=>{
    try{
      const txt = await navigator.clipboard.readText();
      if (txt) elIn.value = txt;
      update();
    }catch(e){
      alert('Clipboard paste is not permitted by the browser context.');
    }
  });

  clearBtn.addEventListener('click', ()=>{
    elIn.value = '';
    update();
  });

  sampleBtn.addEventListener('click', ()=>{
    const demo = [
      'This ‚Äî that ‚Äì or ‚Äí perhaps ‚àí minus ‚Äï bar.',
      'Curly quotes: ‚Äúdouble‚Äù ‚Äòsingle‚Äô; guillemets ¬´oui¬ª ‚Äπnon‚Ä∫.',
      'Ellipsis‚Ä¶ bullets ‚Ä¢ and middle ¬∑ dots.',
      'Non-breaking\u00A0spaces, thin\u2009space, hair\u200Aspace, narrow\u202Fno-break, ideographic\u3000space.',
      'Zero-width: ZWSP\u200B ZWNJ\u200C ZWJ\u200D WJ\u2060 BOM\uFEFF; soft-hyphen\u00AD.',
      'FullwidthÔºöÔº®ÔΩÖÔΩåÔΩåÔΩèÔºÅÔº°Ôº¢Ôº£ÔºëÔºíÔºìÔºèÔºº',
      'Unicode slashes: fraction ‚ÅÑ and division ‚àï.',
      'Line\u2028separator and paragraph\u2029separator.',
      'Accented: na√Øve, caf√©, co√∂perate; combining: e\u0301, a\u0308.',
      'Emoji/foreign will be flagged: Œ©, Êº¢, üòÄ.'
    ].join('\n');
    elIn.value = demo;
    update();
  });

  fileIn.addEventListener('change', async (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    const text = await f.text();
    elIn.value = text;
    update();
    fileIn.value = '';
  });

  // --------------------MAIN APPLICATION
  // Initial
  updateRangeList();
  update();
})();
</script>
</body>
</html>
