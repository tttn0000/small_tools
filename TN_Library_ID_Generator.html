<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TN_Library_ID Generator (Web)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg: #f7f9fc;
    --panel: #ffffff;
    --ink: #0b1526;
    --ink-2:#4b5563;
    --muted:#6b7280;
    --accent:#1c6ef2;
    --ok:#059669;
    --warn:#b45309;
    --err:#e11d48;
    --chip:#eef2f7;
    --border:#e5e7eb;
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  *{box-sizing:border-box}
  .wrap{max-width:1200px; margin:0 auto; padding:20px; display:grid; gap:16px}
  h1{margin:0 0 4px 0; font-size:20px}
  .sub{color:var(--ink-2); font-size:13px}
  .grid{display:grid; gap:16px; grid-template-columns: 1.1fr 0.9fr;}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:14px;}
  .card h2{margin:0 0 8px 0; font-size:16px}
  label{font-weight:600; display:block; margin-bottom:6px}
  .row{display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center}
  .row2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
  .row3{display:grid; grid-template-columns: 1fr 110px; gap:8px}
  input[type="text"], input[type="number"], textarea, select{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  textarea{min-height:140px; resize:vertical}
  .small{font-size:12px; color:var(--muted)}
  .btn{appearance:none; border:1px solid var(--accent); background:var(--accent); color:#fff; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600;}
  .btn.secondary{background:#fff; color:var(--accent)}
  .btn.ghost{background:transparent; border-color:var(--border); color:var(--ink)}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .chip{display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--ink-2)}
  .note{background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; border-radius:10px; padding:10px 12px; font-size:13px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px}
  .output{min-height:280px; white-space:pre; overflow:auto; border:1px solid var(--border); border-radius:8px; padding:12px; background:#fff; font:13px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  .split{display:grid; gap:16px; grid-template-columns: 1fr 1fr;}
  .mutual label{font-weight:400}
  .mutual .item{display:flex; gap:10px; align-items:center}
  .mutual input[type="checkbox"]{transform:translateY(1px)}
  .rightcol{display:grid; gap:16px}
  @media (max-width: 950px){.grid{grid-template-columns:1fr}.split{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <h1>TN_Library_ID Generator</h1>
    <div class="sub">Generate TN_Library_IDs from JSON arrays or manual entry.</div>
  </div>

  <div class="grid">
    <div class="leftcol">
      <div class="card">
        <h2>Input Method</h2>
        <input id="file" type="file" accept=".json,application/json">
        <textarea id="jsonText" placeholder='[{"title":"Example","year":2024}]'></textarea>
        <div class="toolbar">
          <button id="btnClearPaste" class="btn ghost">Clear</button>
        </div>
        <label>Manual Entry</label>
        <div class="row2">
          <input id="manualTitle" type="text" placeholder="Title">
          <input id="manualYear" type="number" placeholder="Year (e.g., 2024)" min="1000" max="9999">
        </div>
        <button id="btnAddManual" class="btn secondary" style="margin-top:8px">Add to JSON</button>
        <div class="small" id="fileInfo">No data loaded</div>
      </div>

      <div class="card">
        <h2>Formatting Options</h2>
        <div class="mutual">
          <span class="item"><input id="optBrackets" type="checkbox" checked> <label for="optBrackets">Wrap in [[ ]]</label></span>
          <span class="item"><input id="optDot" type="checkbox" checked> <label for="optDot">Add dot point (-)</label></span>
          <span class="item"><input id="optNum" type="checkbox"> <label for="optNum">Add number (1.)</label></span>
          <span class="item"><input id="optAlias" type="checkbox" checked> <label for="optAlias">Add title alias</label></span>
        </div>
        <label>Title Length</label>
        <input id="titleLen" type="number" min="20" max="30" step="1" value="30">
        <label>Change title case (alias only)</label>
        <select id="caseMode">
          <option value="title">title</option>
          <option value="upper">upper</option>
          <option value="lower">lower</option>
          <option value="sentence">sentence</option>
        </select>
      </div>
    </div>

    <div class="rightcol">
      <div class="card">
        <h2>TN Library IDs</h2>
        <div id="output" class="output"></div>
        <div class="toolbar" style="margin-top:8px">
          <button id="btnCopy" class="btn secondary" disabled>Copy</button>
          <button id="btnDownload" class="btn ghost" disabled>Download</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// -------------------- TN_Library_ID Generation Logic --------------------
const TN_ID_TOTAL_MAX = 35; // Max total characters, including 'YYYY-'
const YEAR_LENGTH = 4;
const SEPARATOR_LENGTH = 1; // '-'
const MAX_TITLE_CHARS = TN_ID_TOTAL_MAX - (YEAR_LENGTH + SEPARATOR_LENGTH); // 30
const DEFAULT_TITLE_LENGTH = MAX_TITLE_CHARS;
const MIN_TITLE_LENGTH = 20;
const TITLE_PADDING_CHAR = "-";
const TITLE_REPLACE_CHAR = "_";

function normalizeTitle(title){
  title = (title||"").toLowerCase();
  // Decompose accents and strip combining marks
  title = title.normalize("NFKD").replace(/[\u0300-\u036f]/g, "");
  // Replace non-alphanumeric with underscore
  title = title.replace(/[^a-z0-9]+/g, TITLE_REPLACE_CHAR);
  // Strip leading/trailing underscores
  title = title.replace(/^_+|_+$/g, "");
  // Collapse multiple underscores
  title = title.replace(/_+/g, TITLE_REPLACE_CHAR);
  return title;
}

function padTitle(title, targetLength=DEFAULT_TITLE_LENGTH){
  if(title.length > targetLength) return title.slice(0, targetLength);
  return title + TITLE_PADDING_CHAR.repeat(targetLength - title.length);
}

function generateTNLibraryId(year, title, titleLength=DEFAULT_TITLE_LENGTH){
  if(!/^[0-9]{4}$/.test(year)){
    throw new Error(`Year must be exactly ${YEAR_LENGTH} digits`);
  }
  if(!title.trim()){
    throw new Error("Title cannot be empty");
  }
  // Clamp title length to allowed range and cap to ensure total TN ID <= TN_ID_TOTAL_MAX
  if(titleLength < MIN_TITLE_LENGTH){
    titleLength = MIN_TITLE_LENGTH;
  }
  if(titleLength > MAX_TITLE_CHARS){
    titleLength = MAX_TITLE_CHARS;
  }
  const normalized = normalizeTitle(title);
  const padded = padTitle(normalized, titleLength);
  return `${year}-${padded}`;
}

// -------------------- App Logic --------------------
let papers = [];
let formatted = "";

function refreshOutput(){
  document.getElementById("output").textContent = formatted;
  document.getElementById("btnCopy").disabled = !formatted;
  document.getElementById("btnDownload").disabled = !formatted;
}

function validateAndParseJSON(jsonText) {
  try {
    const parsed = JSON.parse(jsonText);
    if (Array.isArray(parsed)) {
      return { valid: true, data: parsed };
    } else {
      return { valid: false, error: "JSON must be an array" };
    }
  } catch (e) {
    return { valid: false, error: "Invalid JSON format" };
  }
}

function generateFormattedOutput() {
  if (papers.length === 0) {
    formatted = "";
    refreshOutput();
    return;
  }
  
  let length = parseInt(document.getElementById("titleLen").value) || DEFAULT_TITLE_LENGTH;
  // Cap UI-provided length so total TN Library ID stays within 35 chars
  if (length > MAX_TITLE_CHARS) length = MAX_TITLE_CHARS;
  if (length < MIN_TITLE_LENGTH) length = MIN_TITLE_LENGTH;
  const caseMode = document.getElementById("caseMode").value;
  const useBrackets = document.getElementById("optBrackets").checked;
  const useDot = document.getElementById("optDot").checked;
  const useNum = document.getElementById("optNum").checked;
  const useAlias = document.getElementById("optAlias").checked;

  const lines = papers.map((p, i) => {
    let base = generateTNLibraryId(String(p.year), p.title, length);
    if (useAlias) {
      let alias = p.title;
      if (caseMode === "upper") alias = alias.toUpperCase();
      if (caseMode === "lower") alias = alias.toLowerCase();
      if (caseMode === "title") alias = alias.replace(/\w\S*/g, w => w[0].toUpperCase() + w.slice(1).toLowerCase());
      if (caseMode === "sentence") alias = alias.charAt(0).toUpperCase() + alias.slice(1).toLowerCase();
      base += `|${alias}`;
    }
    if (useBrackets) base = `[[${base}]]`;
    if (useNum) return `${i + 1}. ${base}`;
    if (useDot) return `- ${base}`;
    return base;
  });
  formatted = lines.join("\n");
  refreshOutput();
}

function updateFromJSON() {
  const jsonText = document.getElementById("jsonText").value.trim();
  if (!jsonText) {
    papers = [];
    document.getElementById("fileInfo").textContent = "No data loaded";
    generateFormattedOutput();
    return;
  }
  
  const result = validateAndParseJSON(jsonText);
  if (result.valid) {
    papers = result.data;
    document.getElementById("fileInfo").textContent = `Loaded ${papers.length} entries`;
    generateFormattedOutput();
  } else {
    papers = [];
    document.getElementById("fileInfo").textContent = `Error: ${result.error}`;
    generateFormattedOutput();
  }
}

// File input handler
document.getElementById("file").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    document.getElementById("jsonText").value = text;
    updateFromJSON();
  } catch (err) {
    alert("Error reading file: " + err.message);
  }
  e.target.value = ""; // Reset file input
});

// Event listeners for automatic updates
document.getElementById("jsonText").addEventListener("input", updateFromJSON);

document.getElementById("btnClearPaste").onclick = ()=>{
  document.getElementById("jsonText").value="";
  updateFromJSON();
};

document.getElementById("btnAddManual").onclick = ()=>{
  const title = document.getElementById("manualTitle").value.trim();
  const year = document.getElementById("manualYear").value.trim();
  if(!title || !year) return alert("Both Title and Year required");
  const entry = [{"title":title,"year":parseInt(year)}];
  const currentValue = document.getElementById("jsonText").value.trim();
  if (currentValue) {
    document.getElementById("jsonText").value = currentValue + ",\n" + JSON.stringify(entry[0], null, 2);
  } else {
    document.getElementById("jsonText").value = JSON.stringify(entry, null, 2);
  }
  document.getElementById("manualTitle").value="";
  document.getElementById("manualYear").value="";
  updateFromJSON();
};

// Event listeners for formatting options to trigger automatic updates
document.getElementById("optBrackets").addEventListener("change", generateFormattedOutput);
document.getElementById("optDot").addEventListener("change", generateFormattedOutput);
document.getElementById("optNum").addEventListener("change", generateFormattedOutput);
document.getElementById("optAlias").addEventListener("change", generateFormattedOutput);
document.getElementById("titleLen").addEventListener("input", generateFormattedOutput);
document.getElementById("caseMode").addEventListener("change", generateFormattedOutput);

document.getElementById("btnCopy").onclick = async ()=>{
  await navigator.clipboard.writeText(formatted);
  alert("Copied!");
};

document.getElementById("btnDownload").onclick = ()=>{
  const blob = new Blob([formatted], {type:"text/plain"});
  const a = document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="tn_library_ids.txt";
  a.click();
};
</script>
</body>
</html>
